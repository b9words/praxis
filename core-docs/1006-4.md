### **Part 1: The Strategic Goal â€” The "First Clear Step"**

The entire onboarding flow has one objective: **deliver the user to their dashboard with a single, clear, and compelling next action.** This action must be the first lesson of their chosen learning path.

**The Narrative Arc:**
1.  **Welcome & Mission:** Frame the journey.
2.  **The Situation Briefing:** Understand the user's strategic goal.
3.  **The Diagnostic & Resource Allocation:** Help the user identify their primary competency gap.
4.  **The First Deployment:** Present the user with their first, foundational lesson based on their choices.

This turns onboarding into an empowering, personalized experience that demonstrates the platform's value immediately.

---

### **Part 2: The Technical & UX Implementation Plan**

This plan refines your existing `PrescriptiveOnboarding.tsx` and ensures it connects perfectly to your `FocusedDashboard.tsx`.

#### **Step 1: Overhaul the Onboarding Component (`components/onboarding/PrescriptiveOnboarding.tsx`)**

We will restructure this component into a multi-step flow that tells the narrative arc.

```typescript
// In components/onboarding/PrescriptiveOnboarding.tsx

'use client';

import { useState } from 'react';
// ... other imports: Button, Textarea, Card, Badge, etc.

// --- Step 1: Define the components for each step ---

// Welcome & Mission
const StepWelcome = ({ onNext }) => (
  <div className="text-center space-y-8">
    <h1 className="text-3xl font-bold text-gray-900">Access the Proving Ground.</h1>
    <p className="text-lg text-gray-600 max-w-2xl mx-auto">
      You are about to embark on a systematic journey to build world-class business acumen.
      This initial briefing will calibrate your learning path.
    </p>
    <Button onClick={onNext} size="lg">Begin Assessment</Button>
  </div>
);

// The Situation Briefing
const StepGoals = ({ onNext, objective, setObjective }) => (
  <div className="max-w-2xl mx-auto space-y-6">
    <h2 className="text-2xl font-semibold text-gray-900">The Situation Briefing</h2>
    <p className="text-gray-700">
      Every leader's journey starts with a clear-eyed assessment of their current position and desired end-state.
      Describe the strategic objective of your career. What market are you trying to win in the next five years?
    </p>
    <Textarea
      value={objective}
      onChange={(e) => setObjective(e.target.value)}
      placeholder="Example: To transition from a senior engineering role to leading a new product division..."
      className="min-h-[120px]"
    />
    <div className="flex justify-end">
      <Button onClick={onNext} disabled={!objective.trim()}>Log Assessment</Button>
    </div>
  </div>
);

// The Diagnostic & Resource Allocation
const StepCompetency = ({ onNext, selected, setSelected, objective }) => (
  <div className="max-w-3xl mx-auto space-y-6">
    <h2 className="text-2xl font-semibold text-gray-900">Diagnostic & Resource Allocation</h2>
    <div className="bg-gray-50 border border-gray-200 p-4">
      <p className="text-xs text-gray-500 font-mono mb-1">LOGGED OBJECTIVE</p>
      <p className="text-sm text-gray-900">{objective}</p>
    </div>
    <p className="text-gray-700">
      Acknowledged. Achieving this requires closing a critical competency gap. Based on your objective, which of these 10 core competencies represents your most significant opportunity for growth?
    </p>
    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
      {COMPETENCIES.map((competency) => (
        <Card
          key={competency.id}
          className={`cursor-pointer border-2 ${selected === competency.id ? 'border-gray-900 bg-gray-50' : 'hover:border-gray-400'}`}
          onClick={() => setSelected(competency.id)}
        >
          <CardContent className="p-4">
            <h3 className="font-semibold text-gray-900">{competency.title}</h3>
            <p className="text-xs text-gray-600 mt-1">{competency.description}</p>
          </CardContent>
        </Card>
      ))}
    </div>
    <div className="flex justify-end">
      <Button onClick={onNext} disabled={!selected}>Confirm Allocation</Button>
    </div>
  );
);

// The First Deployment (Final Step)
const StepFirstLesson = ({ onComplete, competency, isLoading }) => {
  const foundationalLesson = getFoundationalLesson(competency.domainId);
  return (
    <div className="text-center space-y-8 max-w-2xl mx-auto">
      <h2 className="text-2xl font-semibold text-gray-900">Authorization Complete. Welcome, Operative.</h2>
      <p className="text-gray-700">
        Your initial focus will be on **{competency.title}**. Your first clear step is a foundational lesson to build the core principles.
      </p>
      <Card className="text-left">
        <CardHeader>
          <CardTitle>{foundationalLesson.lessonTitle}</CardTitle>
          <CardDescription>{foundationalLesson.description}</CardDescription>
        </CardHeader>
      </Card>
      <Button onClick={onComplete} disabled={isLoading} size="lg">
        {isLoading ? "Finalizing Setup..." : "Begin Analysis"}
      </Button>
    </div>
  );
};

// --- Step 2: The Main Onboarding Component ---

export default function PrescriptiveOnboarding({ user }) {
  const [currentStep, setCurrentStep] = useState(0);
  const [strategicObjective, setStrategicObjective] = useState('');
  const [selectedCompetencyId, setSelectedCompetencyId] = useState(null);
  const [isLoading, setIsLoading] = useState(false);
  const router = useRouter();

  const saveOnboardingMutation = useMutation({
    mutationFn: async (data) => {
      // This is your existing API call to save the data
      return fetchJson('/api/onboarding', { method: 'POST', body: data });
    },
    onSuccess: () => {
      // On success, redirect to the dashboard. The dashboard will now have the
      // necessary info to show the "First Clear Step".
      toast.success("Onboarding complete. Welcome to the Proving Ground.");
      router.push('/dashboard');
      router.refresh(); // Crucial to reload server components on the dashboard
    },
    onError: (error) => {
      toast.error(error.message);
      setIsLoading(false);
    }
  });

  const handleNext = () => setCurrentStep(prev => prev + 1);
  
  const handleComplete = () => {
    setIsLoading(true);
    saveOnboardingMutation.mutate({
      strategicObjective,
      competencyId: selectedCompetencyId,
    });
  };

  const steps = [
    <StepWelcome onNext={handleNext} />,
    <StepGoals onNext={handleNext} objective={strategicObjective} setObjective={setStrategicObjective} />,
    <StepCompetency onNext={handleNext} selected={selectedCompetencyId} setSelected={setSelectedCompetencyId} objective={strategicObjective} />,
    <StepFirstLesson onComplete={handleComplete} competency={COMPETENCIES.find(c => c.id === selectedCompetencyId)} isLoading={isLoading} />
  ];

  return (
    <div className="min-h-screen bg-white py-12">
      <div className="max-w-4xl mx-auto px-6">
        {/* Progress Header */}
        <div className="mb-12">
          <Progress value={(currentStep / (steps.length - 1)) * 100} className="h-2" />
        </div>
        
        {steps[currentStep]}
      </div>
    </div>
  );
}
```

#### **Step 2: Enhance the Backend Onboarding Logic**

Your existing `POST` function in `app/api/onboarding/route.ts` is a good start. We need to ensure it saves the user's choices in a way the dashboard can easily query.

**File to Edit:** `app/api/onboarding/route.ts`

**Action:** Instead of just updating the `bio`, we will also set the user's `currentResidency` and potentially a new field for their primary competency focus. Let's add a `focus_competency` field to the `UserResidency` model.

**1. Update `prisma/schema.prisma`:**
```prisma
model UserResidency {
  // ... existing fields
  focusCompetency String? @map("focus_competency") // e.g., 'capital-allocation'
}
```
*Run `npm run db:push` after this change.*

**2. Update the API Route:**
```typescript
// In app/api/onboarding/route.ts
// ... imports

export async function POST(request: NextRequest) {
  // ... (user check)

  const body = await request.json();
  const { strategicObjective, competencyId } = body;

  // ... (validation)

  // Find the domainId for the chosen competency
  const selectedCompetency = COMPETENCIES.find(c => c.id === competencyId);
  const domainId = selectedCompetency?.domainId;

  // We'll set the residency to Year 1 by default for all new users.
  const residencyYear = 1;

  // Use a transaction to update both profile and residency
  await prisma.$transaction([
    prisma.profile.update({
      where: { id: user.id },
      data: { bio: strategicObjective },
    }),
    prisma.userResidency.upsert({
      where: { userId: user.id },
      create: {
        userId: user.id,
        currentResidency: residencyYear,
        focusCompetency: domainId,
      },
      update: {
        currentResidency: residencyYear,
        focusCompetency: domainId,
      },
    })
  ]);

  return NextResponse.json({ success: true });
}
```

#### **Step 3: Connect Onboarding to the Dashboard's "First Clear Step"**

This is the final, crucial link. We will modify the dashboard's data-fetching logic (`lib/dashboard-assembler.ts`) to check if a user has just completed onboarding and, if so, override the normal recommendation with their "First Clear Step."

**File to Edit:** `lib/dashboard-assembler.ts`

**Action:** Add logic to prioritize the foundational lesson from the user's `focusCompetency`.

```typescript
// In lib/dashboard-assembler.ts
// ... imports

export async function assembleDashboardData(userId: string): Promise<DashboardData> {
  // ... (existing parallel fetches)

  // --- ADD THIS LOGIC BLOCK ---
  // Check if the user has a `focusCompetency` set from onboarding
  const userResidency = await prisma.userResidency.findUnique({
    where: { userId },
    select: { focusCompetency: true }
  });
  
  // Also check if the user has made ANY progress yet
  const progressCount = await prisma.userLessonProgress.count({ where: { userId } });
  const simulationCount = await prisma.simulation.count({ where: { userId } });

  let primaryRecommendationOverride: Recommendation | null = null;

  // If the user has a focus competency and has made zero progress, this is their first login.
  if (userResidency?.focusCompetency && progressCount === 0 && simulationCount === 0) {
    const foundationalLesson = getFoundationalLesson(userResidency.focusCompetency);
    if (foundationalLesson) {
      primaryRecommendationOverride = {
        type: 'curriculum',
        id: `${foundationalLesson.domain}-${foundationalLesson.module}-${foundationalLesson.lesson}`,
        title: foundationalLesson.lessonTitle,
        reason: "Your first clear step, based on your onboarding assessment.",
        url: foundationalLesson.url,
        competencyName: COMPETENCIES.find(c => c.domainId === userResidency.focusCompetency)?.title,
      };
    }
  }
  // --- END OF LOGIC BLOCK ---

  // ... (existing logic to get recommendationResult)

  // --- MODIFY THE RETURN OBJECT ---
  // In the final `return` statement of the function:

  return {
    // ... all other dashboard data ...
    recommendation: {
      primary: primaryRecommendationOverride || recommendationResult.primary, // Override if applicable
      alternates: primaryRecommendationOverride ? [] : recommendationResult.alternates, // Show no alternates on first step
    },
  };
}
```

This plan creates a seamless, prescriptive journey:
1.  The user is guided through a narrative-driven onboarding that feels like a strategic assessment.
2.  Their choices are saved to their profile, defining their initial focus.
3.  When they land on the dashboard for the very first time, it uses this saved focus to present them with a single, clear, unmissable "First Clear Step."

This flawless transition is the key to converting a new signup into an engaged, active member from their very first session.