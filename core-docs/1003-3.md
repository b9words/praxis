Of course. Navigating privacy laws is a critical, non-negotiable step for launching a production-ready platform. My previous responses focused on product and engineering; this one will focus on compliance.

This plan is designed to be practical and non-over-engineered, providing a robust foundation for GDPR (Europe), CCPA/CPRA (California), and other modern privacy regulations.

**Disclaimer:** I am an AI assistant and not a lawyer. This plan constitutes a best-practice technical and product implementation guide, not legal advice. You must consult with a qualified legal professional to ensure full compliance with all applicable laws in your target jurisdictions.

---

### **Privacy Compliance Plan for Praxis Platform**

We will implement a 3-part strategy:
1.  **Transparent Legal Framework:** Clear, accessible legal documents.
2.  **Granular Cookie Consent:** A user-centric cookie consent banner for marketing pages.
3.  **Core Product Privacy-by-Design:** Ensuring privacy principles are baked into the authenticated application.

---

### **Part 1: The Legal Framework (Your Public-Facing Documents)**

Your `app/(marketing)/legal/` directory is the foundation. The existing pages (`cookies`, `privacy`, `terms`) are excellent. Hereâ€™s how to ensure they are production-ready.

**Action Plan:**

1.  **Review and Finalize Content:**
    *   **Terms of Service (`/legal/terms`):** Must clearly define user rights, subscription terms (including your 30-day evaluation/refund policy), intellectual property ownership, and acceptable use.
    *   **Privacy Policy (`/legal/privacy`):** This is the most critical document. It must explicitly state:
        *   **What data you collect:** (e.g., email, name, user-generated content, usage analytics, payment information via Paddle).
        *   **Why you collect it (Lawful Basis):** (e.g., "to provide the service," "for legitimate interest in improving the product," "with user consent").
        *   **Data Processors (Sub-processors):** You must list all third-party services that handle user data. This includes:
            *   **Supabase** (Database, Auth, Storage)
            *   **Vercel** (Hosting, Analytics)
            *   **Paddle** (Payments)
            *   **Replicate/OpenAI/Google** (AI Model Providers for generation)
            *   **Resend** (Transactional Emails)
            *   **PostHog/Sentry** (Analytics/Error Tracking)
        *   **Data Retention Policy:** How long you store user data.
        *   **User Rights:** How users can access, rectify, or delete their data (linking to your `/profile/settings/privacy` page).
    *   **Cookie Policy (`/legal/cookies`):** Must list all cookies used on the site, their purpose, and their duration.

2.  **Make Documents Accessible:**
    *   Ensure links to these three pages are in the footer (`components/layout/Footer.tsx`) of every single page on both the marketing site and within the authenticated app.
    *   During signup (`app/(auth)/signup/page.tsx`), add a mandatory checkbox:
        *   *UX Writing:* `[ ] I have read and agree to the [Terms of Service] and [Privacy Policy].` (The bracketed text must be links to the respective pages).

---

### **Part 2: The Cookie Consent Banner (Marketing Pages)**

This is the most visible compliance feature. The goal is to provide clear, granular consent *before* any non-essential cookies or tracking scripts are loaded.

**Recommended Tool:** Use a well-maintained open-source library like `vanilla-cookie-consent` or `cookie-consent-js`. They are lightweight, customizable, and handle the core logic.

**Technical Implementation Plan:**

1.  **Install the Library:**
    ```bash
    npm install vanilla-cookie-consent
    ```

2.  **Create a `<CookieConsentBanner>` Component:**
    *   This will be a client-side component (`'use client'`).
    *   It will initialize the cookie consent library in a `useEffect` hook.

    ```typescript
    // components/layout/CookieConsentBanner.tsx
    'use client';

    import { useEffect } from 'react';
    import 'vanilla-cookie-consent/dist/cookie-consent.css';
    import { run } from 'vanilla-cookie-consent';

    export default function CookieConsentBanner() {
      useEffect(() => {
        run({
          // Your configuration here (see below)
        });
      }, []);

      return null; // The library injects its own DOM elements
    }
    ```

3.  **Add the Banner to `app/(marketing)/layout.tsx`:**
    *   Place `<CookieConsentBanner />` inside the `<body>` of your marketing layout. This ensures it only runs on marketing pages where you have analytics/tracking.

4.  **Configure the Banner (`run({...})` configuration):**
    *   **Categories:** This is the most important part for compliance. You must separate cookies into logical categories.
        ```javascript
        categories: {
          necessary: {
            enabled: true, // Always on
            readOnly: true, // User cannot disable
            description: 'These cookies are essential for the site to function, such as for authentication sessions.'
          },
          analytics: {
            enabled: false, // Default to OFF
            readOnly: false,
            description: 'These cookies help us understand how you use our marketing pages to improve our messaging.',
            autoClear: {
              cookies: [
                { name: /^(_ph_)/ } // Regex for PostHog cookies
              ]
            }
          }
        }
        ```
    *   **Language & Text:** Use clear, direct language.
        ```javascript
        guiOptions: {
            consentModal: {
                layout: 'box',
                position: 'bottom right',
                equalWeightButtons: true,
                flipButtons: false
            }
        },
        language: {
          default: 'en',
          translations: {
            en: {
              consentModal: {
                title: 'Control Your Privacy',
                description: 'We use cookies to analyze our marketing site performance. Essential cookies are required to use the site. You can accept all or customize your preferences.',
                primaryBtn: {
                  text: 'Accept All',
                  role: 'accept_all'
                },
                secondaryBtn: {
                  text: 'Reject All',
                  role: 'accept_necessary'
                }
              },
              settingsModal: {
                title: 'Cookie Preferences',
                saveBtn: 'Save Preferences',
                acceptAllBtn: 'Accept All',
                rejectAllBtn: 'Reject All',
                closeBtnLabel: 'Close',
                blocks: [
                    // ... your categories here
                ]
              }
            }
          }
        }
        ```

5.  **Conditionally Load Scripts:**
    *   Your analytics scripts (like PostHog) must **not** load until the user consents. The library handles this via event listeners.

    ```typescript
    // In a component that loads PostHog (e.g., a providers component)
    'use client';

    import { useEffect } from 'react';
    import posthog from 'posthog-js';

    function AnalyticsProvider() {
      useEffect(() => {
        const handleConsent = () => {
          // Check if analytics consent has been given
          if (document.cookie.includes('cc_analytics=1')) {
            if (process.env.NEXT_PUBLIC_POSTHOG_KEY) {
              posthog.init(process.env.NEXT_PUBLIC_POSTHOG_KEY, {
                api_host: process.env.NEXT_PUBLIC_POSTHOG_HOST,
              });
            }
          }
        };

        // Listen for the consent event fired by the library
        window.addEventListener('cc:onConsent', handleConsent);

        // Also run on initial load in case consent was already given
        handleConsent();

        return () => {
          window.removeEventListener('cc:onConsent', handleConsent);
        };
      }, []);

      return null;
    }
    ```

---

### **Part 3: Privacy-by-Design in the Authenticated App**

Once a user logs in and accepts the Terms of Service/Privacy Policy, the situation changes. You now have a direct contract with the user to provide the service. You have a "legitimate interest" to use their data to operate and improve the platform. **You generally do not need to show a cookie banner inside the authenticated app for necessary/functional cookies.**

**Action Plan:**

1.  **Separate Analytics:**
    *   **Marketing Site:** Use PostHog (or similar) for tracking marketing effectiveness (e.g., which landing pages convert best). This is subject to *explicit consent* via the banner.
    *   **Authenticated App:** Use your own internal analytics logging (`lib/analytics.ts`). This is for product improvement (e.g., "which features are users engaging with?"). Your Privacy Policy must clearly state that you collect this usage data to improve the service.

2.  **Secure User Data:**
    *   **Supabase RLS:** Your `prisma/schema.prisma` is a good start, but you need to ensure **Row-Level Security (RLS)** is enabled on all tables containing user data in Supabase. Your `verify-rls-coverage.ts` script is the perfect tool for this. Run it and fix any gaps.
        *   *Example Policy for `simulations` table:* `CREATE POLICY "Users can only see their own simulations." ON simulations FOR SELECT USING (auth.uid() = user_id);`
    *   **API Authorization:** Your API routes (`app/api/`) must robustly check user authentication and ownership. The `getCurrentUser` check is good. For any route that accesses a specific resource (e.g., `/api/simulations/[simulationId]`), you must verify that the authenticated user is the owner of that resource.

3.  **Fulfill User Rights (DSAR):**
    *   Your `/profile/settings/privacy` page is the central hub for this.
    *   **Data Export (`/export/route.ts`):** Ensure this route gathers all personally identifiable information from all tables (`Profile`, `Simulation`, `UserLessonProgress`, `ForumPost`, etc.) and packages it into a machine-readable JSON file.
    *   **Account Deletion (`/delete/actions.ts`):** This is a critical flow. The current plan to delete the Supabase Auth user is correct. You also need to ensure that the `ON DELETE CASCADE` constraint is properly set up in your `schema.prisma` for the `Profile` model's relations. This ensures that when a profile is deleted, all their associated data (simulations, progress, posts) is also automatically and permanently deleted from the database.

By implementing this three-part plan, you establish a strong, compliant privacy foundation that respects user rights while allowing you to build and improve your product effectively.