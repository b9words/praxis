### **Document 2: Technical Specification Document (TSD)**

**Product:** The Execemy Program
**Version:** 1.0
**Date:** October 28, 2025
**Owner:** Development Team

## **1. System Architecture**

### **1.1. Overview**
The Execemy Program will be a full-stack application built on a modern Jamstack architecture. The system is designed for scalability, security, and a rich user experience, leveraging serverless and managed services to minimize infrastructure overhead.

### **1.2. Architecture Diagram**

```
                  +-------------------------+
                  |       User's Browser    |
                  +-------------------------+
                           |   /|\ (HTTPS)
                           |    |
                  +-------------------------+
                  |  Next.js Frontend       |
                  |  (Vercel Hosting)       |
                  |  - React Components     |
                  |  - Shadcn/ui Primitives |
                  |  - Static Site Gen (SSG)|
                  +-------------------------+
                           |   /|\ (Supabase Client SDK)
                           |    |
                  +-------------------------------------------------+
                  |  Supabase Backend-as-a-Service (BaaS)           |
                  |  +---------------------+  +-------------------+ |
                  |  |  Postgres Database  |  |  Auth Service     | |
                  |  |  - Tables & Views   |  |  - JWTs, RLS      | |
                  |  |  - RLS Policies     |  |  - Social Logins  | |
                  |  +---------------------+  +-------------------+ |
                  |  +---------------------+  +-------------------+ |
                  |  |  Storage Service    |  |  Edge Functions   | |
                  |  |  - Avatars          |  |  (Deno Runtime)   | |
                  |  |  - Case File Assets |  |  - Secure AI Calls| |
                  |  +---------------------+  +-------------------+ |
                  +-------------------------------------------------+
                                                     |
                                                     | (REST API, HTTPS)
                                                     |
                                            +------------------+
                                            |  3rd Party LLM   |
                                            |  (e.g., Gemini)  |
                                            +------------------+
```

### **1.3. Technology Stack**
*   **Frontend Framework:** Next.js 14+ (App Router)
*   **UI Library:** Shadcn/ui
*   **Backend & Database:** Supabase (Postgres, Auth, Storage, Edge Functions)
*   **Deployment:** Vercel
*   **LLM Provider:** Google Gemini API (or equivalent) via REST

---

## **2. Supabase Database Schema**

The schema is designed with a relational structure to ensure data integrity. Row-Level Security (RLS) will be enabled on all tables containing user-specific data. All `id` columns are `UUID` and `created_at`/`updated_at` are `timestamptz`.

### **2.1. `profiles`**
Stores public user data. Links to the `auth.users` table.
| Column | Type | Constraints | RLS Policy |
| :--- | :--- | :--- | :--- |
| `id` | `uuid` | Primary Key, References `auth.users.id` | `(select auth.uid()) = id` (Users can only update their own profile) |
| `username` | `text` | Unique, Not Null | Public Read |
| `full_name` | `text` | Nullable | Public Read |
| `avatar_url`| `text` | Nullable | Public Read |
| `is_public` | `boolean`| Not Null, Default `false`| Users can only update their own |

### **2.2. `competencies`**
Stores the hierarchical competency framework.
| Column | Type | Constraints |
| :--- | :--- | :--- |
| `id` | `uuid` | Primary Key |
| `name` | `text` | Not Null |
| `description` | `text` | Nullable |
| `parent_id` | `uuid` | Foreign Key to `competencies.id` (self-referencing) |

### **2.3. `articles` (The Static Library Content)**
| Column | Type | Constraints |
| :--- | :--- | :--- |
| `id` | `uuid` | Primary Key |
| `competency_id`| `uuid` | Foreign Key to `competencies.id` |
| `title` | `text` | Not Null |
| `content` | `text` | Not Null (Markdown format) |

### **2.4. `cases` (The Static Simulation Content)**
| Column | Type | Constraints |
| :--- | :--- | :--- |
| `id` | `uuid` | Primary Key |
| `title` | `text` | Not Null |
| `briefing_doc`| `text` | Not Null (Markdown) |
| `datasets` | `jsonb` | Nullable (e.g., financial statements) |
| `rubric` | `jsonb` | Not Null (The static rubric for the AI Coach) |

### **2.5. `simulations`**
Records a user's attempt at a case. This is the central table linking users to cases.
| Column | Type | Constraints | RLS Policy |
| :--- | :--- | :--- | :--- |
| `id` | `uuid` | Primary Key | `(select auth.uid()) = user_id` |
| `user_id` | `uuid` | Foreign Key to `profiles.id` | (Users can only read their own simulations) |
| `case_id` | `uuid` | Foreign Key to `cases.id` |
| `status` | `enum` | `'in_progress', 'completed'` |
| `user_inputs`| `jsonb` | Stores all user decisions and justifications |

### **2.6. `debriefs`**
Stores the output from the AI Coach.
| Column | Type | Constraints | RLS Policy |
| :--- | :--- | :--- | :--- |
| `id` | `uuid` | Primary Key | `(select auth.uid()) = (select user_id from simulations where id = simulation_id)` |
| `simulation_id`|`uuid` | Unique, Foreign Key to `simulations.id` | (Users can only read debriefs for their own simulations) |
| `scores` | `jsonb` | Not Null (Structured scores based on the rubric) |
| `summary_text`| `text` | Not Null (The qualitative feedback) |
| `radar_chart_data`|`jsonb` | Not Null |

---

## **3. API & Function Endpoints (Supabase Edge Functions)**

All interactions with the external LLM API will be proxied through secure Edge Functions to protect API keys and manage logic.

### **3.1. `POST /functions/v1/ask-study-assistant`**
*   **Purpose:** To handle the Smart Study Assistant Q&A.
*   **Request Body:** `{ "articleContent": "...", "userQuestion": "..." }`
*   **Logic:**
    1.  Receives the full static text of the article and the user's question from the client.
    2.  Constructs a prompt using the prompt engineering guide (see section 4).
    3.  Calls the LLM API.
    4.  Returns the LLM's answer to the client.
*   **Security:** Authenticated users only.

### **3.2. `POST /functions/v1/generate-debrief`**
*   **Purpose:** The core function for the AI Coach.
*   **Request Body:** `{ "simulationId": "..." }`
*   **Logic:**
    1.  Function is invoked by the client when a simulation is completed.
    2.  Uses the `simulationId` to securely query the database for the associated `case.rubric` and `simulation.user_inputs`.
    3.  Constructs a detailed prompt with the rubric and the user's decisions.
    4.  Calls the LLM API, enforcing a strict JSON output.
    5.  Parses and validates the returned JSON.
    6.  Inserts a new row into the `debriefs` table.
    7.  Returns the `debriefId` to the client.
*   **Security:** Authenticated users can only call this for their own simulations.

---

## **4. AI Integration & Prompt Engineering Guide**

This section defines the precise structure of prompts to ensure predictable, auditable, and high-quality AI responses.

### **4.1. Core Principle**
All prompts will use a "System-User" structure. The System prompt will define the AI's role, constraints, and required output format.

### **4.2. Prompt for `AI Coach / generate-debrief`**
*   **System Prompt Template:**
    ```
    You are an expert business school professor and executive coach named 'The Execemy Coach'. Your task is to analyze a user's performance in a business simulation and provide a structured, data-driven debrief.

    You will be given a rubric and the user's submitted decisions. You MUST evaluate the user's inputs STRICTLY against the provided rubric. Do not introduce outside information or subjective opinions.

    Your response MUST be a single, valid JSON object. Do not include any text or markdown before or after the JSON object.

    The JSON object must conform to the following schema:
    {
      "scores": [
        {
          "competencyName": "Financial Acumen" | "Strategic Thinking" | "Risk Management",
          "score": number, // A score from 1 to 5
          "justification": "string" // A 1-2 sentence explanation for the score, directly referencing the user's inputs and the rubric's criteria.
        }
      ],
      "summaryText": "string", // A 3-4 sentence overall summary of the user's performance, highlighting one key strength and one area for improvement.
      "radarChartData": {
          "financialAcumen": number,
          "strategicThinking": number,
          "riskManagement": number
      }
    }
    ```
*   **User Prompt Template:**
    ```
    **Rubric:**
    ${case.rubric}

    **User Inputs:**
    ${simulation.user_inputs}
    ```

---

## **5. Frontend Component Architecture (Next.js & Shadcn/ui)**

*   **File Structure:** App Router (`/app`) with route-based component organization.
*   **Core Components:**
    *   `/app/dashboard/page.tsx`: Main dashboard. Fetches user data server-side.
    *   `/app/library/[...slug]/page.tsx`: Dynamic route for viewing `articles`.
    *   `/components/simulation/SimulationWorkspace.tsx`: The main two-panel interface for the simulator, using `<Resizable>` from Shadcn/ui. Manages the state of the active simulation.
    *   `/components/profile/ExecemyRadarChart.tsx`: A client-side component (using a library like Recharts or Chart.js) to render the user's competency chart.
    *   `/components/debrief/DebriefCard.tsx`: Displays the final scores and summary from the AI Coach.