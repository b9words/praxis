// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Profile {
  id                        String   @id
  username                  String   @unique
  fullName                  String?  @map("full_name")
  avatarUrl                 String?  @map("avatar_url")
  bio                       String?
  isPublic                  Boolean  @default(false) @map("is_public")
  role                      String   @default("member")
  emailNotificationsEnabled Boolean  @default(true) @map("email_notifications_enabled")
  createdAt                 DateTime @default(now()) @map("created_at")
  updatedAt                 DateTime @updatedAt @map("updated_at")

  // Relations
  articlesCreated    Article[]             @relation("ArticleCreator")
  articlesUpdated    Article[]             @relation("ArticleUpdater")
  casesCreated       Case[]                @relation("CaseCreator")
  casesUpdated       Case[]                @relation("CaseUpdater")
  simulations        Simulation[]
  lessonProgress     UserLessonProgress[]
  articleProgress    UserArticleProgress[] @relation("UserArticleProgress")
  residency          UserResidency?
  subscription       Subscription?
  notifications      Notification[]
  domainCompletions  DomainCompletion[]
  auditLogs          AuditLog[]
  communityWaitlist  CommunityWaitlist?

  @@index([username])
  @@index([isPublic])
  @@map("profiles")
}

model Competency {
  id            String   @id @default(uuid())
  name          String
  description   String?
  parentId      String?  @map("parent_id")
  level         String
  residencyYear Int?     @map("residency_year")
  displayOrder  Int      @default(0) @map("display_order")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations
  parent           Competency?      @relation("CompetencyHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children         Competency[]     @relation("CompetencyHierarchy")
  articles         Article[]
  caseCompetencies CaseCompetency[]

  @@index([parentId])
  @@index([level])
  @@map("competencies")
}

model Article {
  id           String   @id @default(uuid())
  competencyId String   @map("competency_id")
  title        String
  content      String?
  description  String?
  status       String   @default("draft")
  published    Boolean  @default(false)
  storagePath  String?  @map("storage_path")
  metadata     Json?    @default("{}")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")
  createdBy    String?  @map("created_by")
  updatedBy    String?  @map("updated_by")

  // Relations
  competency Competency            @relation(fields: [competencyId], references: [id], onDelete: Cascade)
  creator    Profile?              @relation("ArticleCreator", fields: [createdBy], references: [id])
  updater    Profile?              @relation("ArticleUpdater", fields: [updatedBy], references: [id])
  progress   UserArticleProgress[]

  @@unique([storagePath])
  @@index([competencyId])
  @@index([status])
  @@index([published])
  @@index([createdBy])
  @@index([storagePath])
  @@map("articles")
}

model Case {
  id               String   @id @default(uuid())
  title            String
  briefingDoc      String?  @map("briefing_doc")
  description      String?
  datasets         Json?
  rubric           Json
  status           String   @default("draft")
  published        Boolean  @default(false)
  difficulty       String?
  estimatedMinutes Int?     @map("estimated_minutes")
  prerequisites    Json?    @default("[]")
  storagePath      String?  @map("storage_path")
  metadata         Json?    @default("{}")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")
  createdBy        String?  @map("created_by")
  updatedBy        String?  @map("updated_by")

  // Relations
  creator      Profile?         @relation("CaseCreator", fields: [createdBy], references: [id])
  updater      Profile?         @relation("CaseUpdater", fields: [updatedBy], references: [id])
  simulations  Simulation[]
  competencies CaseCompetency[]
  files        CaseFile[]

  @@unique([storagePath])
  @@index([status])
  @@index([published])
  @@index([createdBy])
  @@index([storagePath])
  @@map("cases")
}

model CaseCompetency {
  caseId       String @map("case_id")
  competencyId String @map("competency_id")

  // Relations
  case       Case       @relation(fields: [caseId], references: [id], onDelete: Cascade)
  competency Competency @relation(fields: [competencyId], references: [id], onDelete: Cascade)

  @@id([caseId, competencyId])
  @@index([caseId])
  @@index([competencyId])
  @@map("case_competencies")
}

model CaseFile {
  id        String   @id @default(uuid())
  caseId    String   @map("case_id")
  fileId    String   @map("file_id")
  fileName  String   @map("file_name")
  fileType  String   @map("file_type")
  mimeType  String   @default("text/markdown") @map("mime_type")
  content   String?
  size      Int?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  case Case @relation(fields: [caseId], references: [id], onDelete: Cascade)

  @@unique([caseId, fileId])
  @@index([caseId])
  @@index([fileId])
  @@index([caseId, fileId])
  @@map("case_files")
}

model Simulation {
  id          String    @id @default(uuid())
  userId      String    @map("user_id")
  caseId      String    @map("case_id")
  status      String    @default("in_progress")
  userInputs  Json      @default("{}") @map("user_inputs")
  startedAt   DateTime  @default(now()) @map("started_at")
  completedAt DateTime? @map("completed_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  // Relations
  user    Profile  @relation(fields: [userId], references: [id], onDelete: Cascade)
  case    Case     @relation(fields: [caseId], references: [id], onDelete: Cascade)
  debrief Debrief?

  @@index([userId])
  @@index([caseId])
  @@index([status])
  @@index([userId, caseId])
  @@map("simulations")
}

model Debrief {
  id             String   @id @default(uuid())
  simulationId   String   @unique @map("simulation_id")
  scores         Json
  summaryText    String   @map("summary_text")
  radarChartData Json     @map("radar_chart_data")
  rubricVersion  String?  @map("rubric_version")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  // Relations
  simulation Simulation @relation(fields: [simulationId], references: [id], onDelete: Cascade)

  @@index([simulationId])
  @@map("debriefs")
}

model UserLessonProgress {
  id                 String    @id @default(uuid())
  userId             String    @map("user_id")
  domainId           String    @map("domain_id")
  moduleId           String    @map("module_id")
  lessonId           String    @map("lesson_id")
  status             String    @default("not_started")
  progressPercentage Int       @default(0) @map("progress_percentage")
  timeSpentSeconds   Int       @default(0) @map("time_spent_seconds")
  lastReadPosition   Json      @default("{}") @map("last_read_position")
  completedAt        DateTime? @map("completed_at")
  bookmarked         Boolean   @default(false)
  createdAt          DateTime  @default(now()) @map("created_at")
  updatedAt          DateTime  @updatedAt @map("updated_at")

  // Relations
  user Profile @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, domainId, moduleId, lessonId])
  @@index([userId])
  @@index([domainId, moduleId, lessonId])
  @@index([status])
  @@index([bookmarked])
  @@index([userId, status])
  @@map("user_lesson_progress")
}

model UserArticleProgress {
  id          String    @id @default(uuid())
  userId      String    @map("user_id")
  articleId   String    @map("article_id")
  status      String    @default("in_progress")
  completedAt DateTime? @map("completed_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  // Relations
  user    Profile @relation("UserArticleProgress", fields: [userId], references: [id], onDelete: Cascade)
  article Article @relation(fields: [articleId], references: [id], onDelete: Cascade)

  @@unique([userId, articleId])
  @@index([userId])
  @@index([articleId])
  @@index([status])
  @@map("user_article_progress")
}

model UserResidency {
  id               String   @id @default(uuid())
  userId           String   @unique @map("user_id")
  currentResidency Int      @default(1) @map("current_residency")
  startedAt        DateTime @default(now()) @map("started_at")
  updatedAt        DateTime @updatedAt @map("updated_at")
  focusCompetency  String?  @map("focus_competency")

  // Relations
  user Profile @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("user_residency")
}

model TokenUsage {
  id               String   @id @default(uuid())
  date             DateTime @db.Date
  model            String
  promptTokens     Int      @default(0) @map("prompt_tokens")
  completionTokens Int      @default(0) @map("completion_tokens")
  totalTokens      Int      @default(0) @map("total_tokens")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  @@index([date, model])
  @@index([createdAt])
  @@map("token_usage")
}

model Subscription {
  id                   String   @id @default(uuid())
  userId               String   @unique @map("user_id")
  paddleSubscriptionId String   @unique @map("paddle_subscription_id")
  paddlePlanId         String   @map("paddle_plan_id")
  status               String
  currentPeriodStart   DateTime @map("current_period_start")
  currentPeriodEnd     DateTime @map("current_period_end")
  createdAt            DateTime @default(now()) @map("created_at")
  updatedAt            DateTime @updatedAt @map("updated_at")

  // Relations
  user Profile @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([paddleSubscriptionId])
  @@index([status])
  @@map("subscriptions")
}

model Notification {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  type      String
  title     String
  message   String
  read      Boolean  @default(false)
  link      String?
  metadata  Json?    @default("{}")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  user Profile @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([read])
  @@index([createdAt])
  @@index([userId, read])
  @@map("notifications")
}

model LearningPath {
  id          String            @id @default(uuid())
  slug        String            @unique
  title       String
  description String?
  duration    String
  status      String            @default("draft") // draft | published
  createdAt   DateTime          @default(now()) @map("created_at")
  updatedAt   DateTime          @updatedAt @map("updated_at")

  // Relations
  items LearningPathItem[]

  @@index([slug])
  @@index([status])
  @@index([createdAt])
  @@map("learning_paths")
}

model LearningPathItem {
  id          String       @id @default(uuid())
  pathId      String       @map("path_id")
  order       Int
  type        String       // lesson | case
  domain      String?
  module      String?
  lesson      String?
  caseId      String?      @map("case_id")
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @updatedAt @map("updated_at")

  // Relations
  path LearningPath @relation(fields: [pathId], references: [id], onDelete: Cascade)

  @@index([pathId])
  @@index([pathId, order])
  @@map("learning_path_items")
}

model DomainCompletion {
  id                    String    @id @default(uuid())
  userId                String    @map("user_id")
  domainId              String    @map("domain_id")
  completedAt           DateTime  @default(now()) @map("completed_at")
  certificateGeneratedAt DateTime? @map("certificate_generated_at")
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  // Relations
  user Profile @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, domainId])
  @@index([userId])
  @@index([domainId])
  @@index([completedAt])
  @@map("domain_completions")
}

model Job {
  id          String   @id @default(uuid())
  type        String   // debrief_generation, thumbnail_generation, etc.
  status      String   @default("pending") // pending | processing | completed | failed
  payload     Json     @default("{}")
  result      Json?
  error       String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  processedAt DateTime? @map("processed_at")

  @@index([status])
  @@index([type])
  @@index([status, type])
  @@index([createdAt])
  @@map("jobs")
}

model BriefingSchedule {
  id        String   @id @default(uuid())
  weekOf    DateTime @unique @map("week_of") @db.Date
  domainId  String   @map("domain_id")
  moduleId  String   @map("module_id")
  caseId    String   @map("case_id")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([weekOf(sort: Desc)])
  @@index([domainId, moduleId])
  @@map("briefing_schedule")
}

model AuditLog {
  id           String   @id @default(uuid())
  userId       String   @map("user_id")
  action       String   // create | update | delete | status_change | role_change
  resourceType String   @map("resource_type")
  resourceId   String   @map("resource_id")
  changes      Json?    // Stores the changes made
  reason       String?
  createdAt    DateTime @default(now()) @map("created_at")

  // Relations
  user Profile @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([resourceType, resourceId])
  @@index([action])
  @@index([createdAt(sort: Desc)])
  @@map("audit_log")
}

model CommunityWaitlist {
  id        String   @id @default(uuid())
  userId    String   @unique @map("user_id")
  email     String
  createdAt DateTime @default(now()) @map("created_at")
  user      Profile  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("community_waitlist")
}

model AutomatedEmail {
  id          String    @id @default(uuid())
  eventName   String    // 'user_signed_up' | 'domain_completed' | 'user_inactive' (no longer unique - allows multiple drips)
  subject     String
  template    String    // maps to lib/email-templates.tsx keys: 'welcome' | 'general' | ...
  delayDays   Int       @default(0)
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  
  // New fields for newsletter support
  name        String?   // For easier identification in admin UI
  type        String    @default("DRIP") // "DRIP" | "NEWSLETTER"
  summary     String?   // Summary for the archive view
  publishedAt DateTime? // When the newsletter was published/sent

  @@index([eventName, delayDays])
  @@index([isActive])
  @@index([type])
  @@index([publishedAt])
  @@map("automated_emails")
}

model NewsletterSubscriber {
  id        String   @id @default(uuid())
  email     String   @unique
  createdAt DateTime @default(now()) @map("created_at")

  @@map("newsletter_subscribers")
}
